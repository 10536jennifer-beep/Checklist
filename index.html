import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Check, 
  Plus, 
  Trash2, 
  Edit3, 
  Save, 
  X, 
  ShoppingBag, 
  Plane, 
  Percent,
  RotateCcw,
  AlertCircle,
  AlertTriangle,
  Tag
} from 'lucide-react';

const DEFAULT_CATEGORIES = [
  "ğŸ’¦ç›¥æ´—ç”¨å“",
  "ğŸ›ç”Ÿæ´»ç”¨å“",
  "ğŸ’„åŒ–å¦",
  "ğŸ”Œé›»å™¨ç”¨å“",
  "ğŸ“œè­‰ä»¶",
  "ğŸ¥è—¥",
  "ğŸ‘•è¡£æœ",
  "âœ’ï¸æ–‡å…·",
  "ğŸ²é£Ÿç‰©",
  "ğŸ†•å…¶ä»–"
];

// Initial data parsed from user's request
const INITIAL_DATA = [
  // ç›¥æ´—ç”¨å“
  { id: 1, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "æ¯›å·¾Ã—4", note: "", checked: false },
  { id: 2, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "å¸å¦æ²¹", note: "", checked: false },
  { id: 3, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "æ²æµ´ä¹³", note: "å¾·åœ‹å¾ˆä¹¾ç‡¥ï¼Œå»ºè­°å¸¶ä¿æ¿•æ¬¾", checked: false },
  { id: 4, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "æ´—é«®ç²¾", note: "", checked: false },
  { id: 5, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "æ½¤é«®ä¹³", note: "", checked: false },
  { id: 6, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "æ´—é¢ä¹³", note: "", checked: false },
  { id: 7, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "é«®æ²¹", note: "", checked: false },
  { id: 8, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "ç‰™åˆ·", note: "", checked: false },
  { id: 9, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "ç‰™è†", note: "", checked: false },
  { id: 10, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "ç‰™ç·š", note: "", checked: false },
  { id: 11, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "æ´—æ¾¡æ‹–é‹", note: "", checked: false },
  { id: 12, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "è§’è†œå¡‘å‹ç‰‡", note: "åŒ…å«ç›¸é—œæ¸…æ½”æ¶²", checked: false },
  { id: 13, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "äººå·¥æ·šæ¶²", note: "", checked: false },
  { id: 14, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "æ¸…æ´—æ¶²", note: "", checked: false },
  { id: 15, category: "ğŸ’¦ç›¥æ´—ç”¨å“", name: "å¸æ£’", note: "", checked: false },

  // ç”Ÿæ´»ç”¨å“
  { id: 16, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "æ£‰èŠ±æ£’", note: "", checked: false },
  { id: 17, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "é«®åœˆ", note: "", checked: false },
  { id: 18, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "ä¿æ¿•ä¹³æ¶²", note: "å¿…å‚™ï¼æ­æ´²è¶…ä¹¾", checked: false },
  { id: 19, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "ä¿®çœ‰åˆ€", note: "", checked: false },
  { id: 20, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "åŒ–å¦é¡", note: "", checked: false },
  { id: 21, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "ç²‰åˆºå¤¾", note: "", checked: false },
  { id: 22, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "æ¢³å­", note: "", checked: false },
  { id: 23, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "çœ¼ç½©", note: "", checked: false },
  { id: 24, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "è€³å¡", note: "", checked: false },
  { id: 25, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "å£ç½©", note: "", checked: false },
  { id: 26, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "è¡›ç”Ÿæ£‰", note: "", checked: false },
  { id: 27, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "æŒ‡ç”²å‰ª", note: "", checked: false },
  { id: 28, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "ç£¨ç”²æ£’", note: "", checked: false },
  { id: 29, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "æŒ‡ç·£æ²¹", note: "", checked: false },
  { id: 30, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "å°å‰ªåˆ€", note: "è¨˜å¾—æ”¾è¨—é‹", checked: false },
  { id: 31, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "é›¨å‚˜", note: "å¾·åœ‹å¾ˆå¸¸ä¸‹é›¨ï¼Œå»ºè­°å …å›ºé˜²é¢¨", checked: false },
  { id: 32, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "å¡‘è† è¢‹Ã—n", note: "", checked: false },
  { id: 33, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "è¡›ç”Ÿç´™", note: "éš¨èº«åŒ…é‚£ç¨®", checked: false },
  { id: 34, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "æ¿•ç´™å·¾", note: "", checked: false },
  { id: 35, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "å°ç“¶æ´—è¡£ç²¾", note: "å‰›åˆ°ç¬¬ä¸€é€±æ€¥ç”¨", checked: false },
  { id: 36, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "åºŠåŒ…åºŠå¥—", note: "æ³¨æ„å¾·åœ‹æ•é ­å¤šç‚º80x80cmæ–¹å½¢", checked: false },
  { id: 37, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "é˜²ç‹¼å™´éœ§", note: "æ³¨æ„å…¥å¢ƒæ³•è¦ï¼Œé€šå¸¸éœ€æ”¾è¨—é‹", checked: false },
  { id: 38, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "æ´—ç¢—ç²¾", note: "", checked: false },
  { id: 39, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "æ´—ç¢—æµ·ç¶¿", note: "", checked: false },
  { id: 40, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "æŠ¹å¸ƒ", note: "", checked: false },
  { id: 41, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "å»šæˆ¿å‰ªåˆ€", note: "", checked: false },
  { id: 42, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "ç’°ä¿é¤å…·", note: "", checked: false },
  { id: 43, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "åˆ€å­", note: "è¨—é‹ï¼", checked: false },
  { id: 44, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "æ‰‹æ©Ÿæ›ç¹©", note: "æ­æ´²é˜²æ¶å¿…å‚™", checked: false },
  { id: 45, category: "ğŸ›ç”Ÿæ´»ç”¨å“", name: "ä¿æº«ç“¶", note: "", checked: false },

  // åŒ–å¦
  { id: 46, category: "ğŸ’„åŒ–å¦", name: "é˜²æ›¬", note: "", checked: false },
  { id: 47, category: "ğŸ’„åŒ–å¦", name: "éš”é›¢", note: "", checked: false },
  { id: 48, category: "ğŸ’„åŒ–å¦", name: "é®ç‘•", note: "", checked: false },
  { id: 49, category: "ğŸ’„åŒ–å¦", name: "æ—¥æ‹‹", note: "å¤šå¸¶ä¸€é»ï¼Œæ­æ´²è²·éš±çœ¼è¦è™•æ–¹", checked: false },
  { id: 50, category: "ğŸ’„åŒ–å¦", name: "çœ¼è—¥æ°´", note: "", checked: false },
  { id: 51, category: "ğŸ’„åŒ–å¦", name: "çœ‰ç­†", note: "", checked: false },
  { id: 52, category: "ğŸ’„åŒ–å¦", name: "æŸ“çœ‰è†", note: "", checked: false },
  { id: 53, category: "ğŸ’„åŒ–å¦", name: "åˆ·å…·", note: "", checked: false },
  { id: 54, category: "ğŸ’„åŒ–å¦", name: "è…®ç´…", note: "", checked: false },
  { id: 55, category: "ğŸ’„åŒ–å¦", name: "èœœç²‰", note: "", checked: false },
  { id: 56, category: "ğŸ’„åŒ–å¦", name: "çœ¼å½±", note: "", checked: false },
  { id: 57, category: "ğŸ’„åŒ–å¦", name: "ç«æ¯›è†", note: "", checked: false },
  { id: 58, category: "ğŸ’„åŒ–å¦", name: "çœ¼ç·šç­†", note: "", checked: false },
  { id: 59, category: "ğŸ’„åŒ–å¦", name: "å£ç´…", note: "", checked: false },
  { id: 60, category: "ğŸ’„åŒ–å¦", name: "å¤¾ç«æ¯›å™¨", note: "", checked: false },
  { id: 61, category: "ğŸ’„åŒ–å¦", name: "å¸æ²¹é¢ç´™", note: "", checked: false },
  { id: 62, category: "ğŸ’„åŒ–å¦", name: "éš¨èº«é¡", note: "", checked: false },
  { id: 63, category: "ğŸ’„åŒ–å¦", name: "é¦™æ°´", note: "", checked: false },
  { id: 64, category: "ğŸ’„åŒ–å¦", name: "é«®æ²", note: "", checked: false },
  { id: 65, category: "ğŸ’„åŒ–å¦", name: "è­·å”‡è†", note: "å¿…å‚™", checked: false },
  { id: 66, category: "ğŸ’„åŒ–å¦", name: "è­·æ‰‹éœœ", note: "å¿…å‚™", checked: false },

  // é›»å™¨
  { id: 67, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "æª¯ç‡ˆ", note: "å¯è€ƒæ…®å»ç•¶åœ°è²·", checked: false },
  { id: 68, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "å¹é¢¨æ©Ÿ", note: "æ³¨æ„é›»å£“éœ€æ”¯æ´220V", checked: false },
  { id: 69, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "æ²é«®æ£’", note: "æ³¨æ„é›»å£“", checked: false },
  { id: 70, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "è½‰æ›æ’é ­", note: "æ­è¦é›™åœ“é ­ï¼Œå»ºè­°å¸¶2-3å€‹", checked: false },
  { id: 71, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "ç…®é£¯çš„(é›»é‹?)", note: "å‚³çµ±é›»é‹å¥½ç”¨", checked: false },
  { id: 72, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "è¡Œå‹•é›»æº", note: "å¿…é ˆæ”¾æ‰‹æè¡Œæ", checked: false },
  { id: 73, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "ï¼ˆæœ‰ç·šï¼‰è€³æ©Ÿ", note: "", checked: false },
  { id: 74, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "é›»è…¦ + å……é›»å™¨", note: "", checked: false },
  { id: 75, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "æ»‘é¼ ", note: "", checked: false },
  { id: 76, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "å¹³æ¿", note: "", checked: false },
  { id: 77, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "å‚™ç”¨æ‰‹æ©Ÿ", note: "ä»¥é˜²æ‰‹æ©Ÿè¢«å·", checked: false },
  { id: 78, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "æ‰‹éŒ¶ + å……é›»å™¨", note: "", checked: false },
  { id: 79, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "SIMå¡å¡é‡", note: "æ›ç¶²å¡å¿…å‚™", checked: false },
  { id: 80, category: "ğŸ”Œé›»å™¨ç”¨å“", name: "å»¶é•·ç·š", note: "éœ€æ”¯æ´220V", checked: false },

  // è­‰ä»¶
  { id: 81, category: "ğŸ“œè­‰ä»¶", name: "è­·ç…§", note: "æª¢æŸ¥æœ‰æ•ˆæœŸé™", checked: false },
  { id: 82, category: "ğŸ“œè­‰ä»¶", name: "èº«ä»½è­‰", note: "", checked: false },
  { id: 83, category: "ğŸ“œè­‰ä»¶", name: "å¥ä¿å¡", note: "", checked: false },
  { id: 84, category: "ğŸ“œè­‰ä»¶", name: "ä¿¡ç”¨å¡", note: "å»ºè­°å¸¶å…©å¼µä»¥ä¸Šä¸åŒç™¼å¡çµ„ç¹”", checked: false },
  { id: 85, category: "ğŸ“œè­‰ä»¶", name: "é«˜ä¸­ç•¢æ¥­è­‰æ›¸å½±æœ¬", note: "", checked: false },
  { id: 86, category: "ğŸ“œè­‰ä»¶", name: "é‚€è«‹å‡½å½±æœ¬", note: "å…¥æµ·é—œå‚™æŸ¥", checked: false },

  // è—¥
  { id: 87, category: "ğŸ¥è—¥", name: "æ„Ÿå†’è—¥", note: "", checked: false },
  { id: 88, category: "ğŸ¥è—¥", name: "è„¹æ°£è—¥", note: "å¾·åœ‹é£²é£Ÿæ˜“è„¹æ°£", checked: false },
  { id: 89, category: "ğŸ¥è—¥", name: "æ­¢ç—›è—¥", note: "", checked: false },
  { id: 90, category: "ğŸ¥è—¥", name: "èˆŒé ­ç ´æ´è—¥", note: "", checked: false },
  { id: 91, category: "ğŸ¥è—¥", name: "OKè¹¦", note: "", checked: false },
  { id: 92, category: "ğŸ¥è—¥", name: "é˜²èšŠæ¶²", note: "å¤å¤©æœƒæœ‰èšŠèŸ²", checked: false },

  // è¡£æœ (Combined list)
  { id: 93, category: "ğŸ‘•è¡£æœ", name: "å¸ƒé‹/æ¿é‹", note: "å¥½èµ°çš„é‹æœ€é‡è¦", checked: false },
  { id: 94, category: "ğŸ‘•è¡£æœ", name: "æ‹–é‹", note: "å®¤å…§ç”¨", checked: false },
  { id: 95, category: "ğŸ‘•è¡£æœ", name: "è¥ªå­", note: "", checked: false },
  { id: 96, category: "ğŸ‘•è¡£æœ", name: "å…§è¡£Ã—4", note: "", checked: false },
  { id: 97, category: "ğŸ‘•è¡£æœ", name: "å…§è¤²Ã—4", note: "", checked: false },
  { id: 98, category: "ğŸ‘•è¡£æœ", name: "ç™¼ç†±è¡£Ã—3", note: "Uniqlo heattech", checked: false },
  { id: 99, category: "ğŸ‘•è¡£æœ", name: "ç™¼ç†±è¤²Ã—2", note: "", checked: false },
  { id: 100, category: "ğŸ‘•è¡£æœ", name: "æ¯›è¡£Ã—3", note: "æ´‹è”¥å¼ç©¿æ³•", checked: false },
  { id: 101, category: "ğŸ‘•è¡£æœ", name: "å¤§å­¸TÃ—2", note: "", checked: false },
  { id: 102, category: "ğŸ‘•è¡£æœ", name: "é•·è¢–è¥¯è¡«Ã—1", note: "æ­£å¼å ´åˆç”¨", checked: false },
  { id: 103, category: "ğŸ‘•è¡£æœ", name: "å¤–å¥—Ã—2", note: "é˜²é¢¨é˜²æ°´ä½³", checked: false },
  { id: 104, category: "ğŸ‘•è¡£æœ", name: "ç‰›ä»”è¤²Ã—2", note: "", checked: false },
  { id: 105, category: "ğŸ‘•è¡£æœ", name: "æ£‰è¤²Ã—1", note: "å±…å®¶ç©¿", checked: false },
  { id: 106, category: "ğŸ‘•è¡£æœ", name: "ç¹­å‹è¤²Ã—2", note: "", checked: false },
  { id: 107, category: "ğŸ‘•è¡£æœ", name: "çŸ­è¢–Ã—2", note: "å®¤å…§æš–æ°£å¼·æ™‚ç©¿", checked: false },
  { id: 108, category: "ğŸ‘•è¡£æœ", name: "é´¨èˆŒå¸½Ã—1", note: "", checked: false },
  { id: 109, category: "ğŸ‘•è¡£æœ", name: "æ¯›å¸½Ã—1", note: "å†¬å¤©å¿…å‚™", checked: false },
  { id: 110, category: "ğŸ‘•è¡£æœ", name: "åœå·¾", note: "", checked: false },
  { id: 111, category: "ğŸ‘•è¡£æœ", name: "éš¨èº«å°åŒ…åŒ…", note: "", checked: false },
  { id: 112, category: "ğŸ‘•è¡£æœ", name: "ä¸Šèª²èƒŒåŒ…", note: "è£ç­†é›»æ›¸æœ¬", checked: false },
  { id: 113, category: "ğŸ‘•è¡£æœ", name: "å‡ºå»ç©ä¸­åŒ…åŒ…", note: "", checked: false },
  { id: 114, category: "ğŸ‘•è¡£æœ", name: "ç¡è¡£", note: "", checked: false },

  // æ–‡å…·
  { id: 115, category: "âœ’ï¸æ–‡å…·", name: "é‰›ç­†ç›’", note: "å¾·åœ‹æ–‡å…·å¾ˆè²´", checked: false },
  { id: 116, category: "âœ’ï¸æ–‡å…·", name: "ç­†è¨˜æœ¬", note: "", checked: false },
  { id: 117, category: "âœ’ï¸æ–‡å…·", name: "éº—å¯å¸¶æ›¿æ›èŠ¯", note: "å¿…å¸¶ï¼å¾·åœ‹é›£è²·", checked: false },
  { id: 118, category: "âœ’ï¸æ–‡å…·", name: "é•·å°¾å¤¾", note: "", checked: false },
  { id: 119, category: "âœ’ï¸æ–‡å…·", name: "ä¾¿åˆ©è²¼", note: "", checked: false },
  { id: 120, category: "âœ’ï¸æ–‡å…·", name: "è¨ˆç®—æ©Ÿ", note: "", checked: false },

  // é£Ÿç‰©
  { id: 121, category: "ğŸ²é£Ÿç‰©", name: "æ³¡éºµÃ—n", note: "æ€é„‰æ•‘æ˜Ÿ", checked: false },
  { id: 122, category: "ğŸ²é£Ÿç‰©", name: "æ²™èŒ¶é†¬", note: "ç»ç’ƒç½è¨˜å¾—åŒ…å¥½", checked: false },
  { id: 123, category: "ğŸ²é£Ÿç‰©", name: "è±†ç“£é†¬", note: "", checked: false },
];

export default function GermanyPackingList() {
  const [items, setItems] = useState(() => {
    const saved = localStorage.getItem('germany_packing_list');
    return saved ? JSON.parse(saved) : INITIAL_DATA;
  });

  const [categories, setCategories] = useState(() => {
    const saved = localStorage.getItem('germany_packing_categories');
    return saved ? JSON.parse(saved) : DEFAULT_CATEGORIES;
  });

  const [activeCategory, setActiveCategory] = useState(DEFAULT_CATEGORIES[0]);
  const [isAdding, setIsAdding] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const scrollContainerRef = useRef(null);
  
  // Custom Confirmation Modal State
  const [confirmModal, setConfirmModal] = useState({
    isOpen: false,
    title: "",
    message: "",
    actionType: "", // 'delete', 'reset'
    targetId: null
  });
  
  // New Category State
  const [isAddingCategory, setIsAddingCategory] = useState(false);
  const [newCategoryNameStr, setNewCategoryNameStr] = useState("");

  // New Item State
  const [newItemName, setNewItemName] = useState("");
  const [newItemCategory, setNewItemCategory] = useState(DEFAULT_CATEGORIES[0]);
  const [newItemNote, setNewItemNote] = useState("");

  // Update localStorage when items change
  useEffect(() => {
    localStorage.setItem('germany_packing_list', JSON.stringify(items));
  }, [items]);

  // Update localStorage when categories change
  useEffect(() => {
    localStorage.setItem('germany_packing_categories', JSON.stringify(categories));
  }, [categories]);

  const toggleCheck = (id) => {
    setItems(items.map(item => 
      item.id === id ? { ...item, checked: !item.checked } : item
    ));
  };

  const requestDelete = (id) => {
    setConfirmModal({
      isOpen: true,
      title: "åˆªé™¤ç‰©å“",
      message: "ç¢ºå®šè¦åˆªé™¤é€™å€‹ç‰©å“å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚",
      actionType: "delete",
      targetId: id
    });
  };

  const requestReset = () => {
    setConfirmModal({
      isOpen: true,
      title: "é‡ç½®æ‰€æœ‰æ¸…å–®",
      message: "ç¢ºå®šè¦é‡ç½®å—ï¼Ÿé€™å°‡æœƒæ¸…é™¤æ‚¨æ‰€æœ‰æ–°å¢çš„ç‰©å“ã€åˆ†é¡ä»¥åŠå‹¾é¸ç‹€æ…‹ï¼Œå›å¾©åˆ°åˆå§‹è¨­å®šã€‚",
      actionType: "reset",
      targetId: null
    });
  };

  const handleConfirm = () => {
    if (confirmModal.actionType === 'delete') {
      setItems(items.filter(item => item.id !== confirmModal.targetId));
    } else if (confirmModal.actionType === 'reset') {
      setItems(INITIAL_DATA);
      setCategories(DEFAULT_CATEGORIES);
      setActiveCategory(DEFAULT_CATEGORIES[0]);
    }
    setConfirmModal({ ...confirmModal, isOpen: false });
  };

  const addItem = (e) => {
    e.preventDefault();
    if (!newItemName.trim()) return;

    const newItem = {
      id: Date.now(),
      category: newItemCategory,
      name: newItemName,
      note: newItemNote,
      checked: false
    };

    setItems([...items, newItem]);
    setNewItemName("");
    setNewItemNote("");
    setIsAdding(false);
    
    // Switch to the category where item was added
    setActiveCategory(newItemCategory);
  };

  const handleAddCategory = (e) => {
    e.preventDefault();
    if (!newCategoryNameStr.trim()) return;
    
    // Check if duplicate
    if (categories.includes(newCategoryNameStr.trim())) {
      alert("é€™å€‹åˆ†é¡å·²ç¶“å­˜åœ¨äº†ï¼");
      return;
    }

    const newCats = [...categories, newCategoryNameStr.trim()];
    setCategories(newCats);
    setActiveCategory(newCategoryNameStr.trim());
    setNewCategoryNameStr("");
    setIsAddingCategory(false);
    
    // Scroll to the end of the list after a short delay
    setTimeout(() => {
      if (scrollContainerRef.current) {
        scrollContainerRef.current.scrollTo({
          left: scrollContainerRef.current.scrollWidth,
          behavior: 'smooth'
        });
      }
    }, 100);
  };

  const updateItem = (e) => {
    e.preventDefault();
    if (!editingItem.name.trim()) return;

    setItems(items.map(item => 
      item.id === editingItem.id ? editingItem : item
    ));
    setEditingItem(null);
  };

  const progress = useMemo(() => {
    if (items.length === 0) return 0;
    const checkedCount = items.filter(i => i.checked).length;
    return Math.round((checkedCount / items.length) * 100);
  }, [items]);

  // Group items by category (Optimized for single category access)
  const currentCategoryItems = useMemo(() => {
    return items.filter(item => item.category === activeCategory);
  }, [items, activeCategory]);

  // Calculate completion for active category
  const activeCategoryProgress = useMemo(() => {
    if (currentCategoryItems.length === 0) return 0;
    const checked = currentCategoryItems.filter(i => i.checked).length;
    return { current: checked, total: currentCategoryItems.length };
  }, [currentCategoryItems]);

  const allChecked = activeCategoryProgress.total > 0 && activeCategoryProgress.current === activeCategoryProgress.total;

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-24">
      {/* Header Area */}
      <div className="bg-gradient-to-r from-blue-600 to-teal-500 text-white shadow-lg sticky top-0 z-20">
        <div className="max-w-3xl mx-auto px-4 pt-6 pb-2">
          <div className="flex justify-between items-center mb-4">
            <div>
              <h1 className="text-2xl font-bold flex items-center gap-2">
                <Plane className="w-6 h-6" /> å¾·åœ‹äº¤æ›è¡Œææ¸…å–®
              </h1>
              <p className="text-blue-100 text-sm mt-1">é ç¥ç•™å­¸ç”Ÿæ´»é †åˆ©ï¼Alles Gute!</p>
            </div>
            <button 
              onClick={requestReset}
              className="p-2 text-blue-100 hover:text-white transition-colors"
              title="é‡ç½®æ¸…å–®"
            >
              <RotateCcw className="w-5 h-5" />
            </button>
          </div>
          
          {/* Global Progress Bar */}
          <div className="bg-blue-900/30 rounded-full h-3 relative overflow-hidden backdrop-blur-sm mb-1">
            <div 
              className="bg-white h-full transition-all duration-500 ease-out"
              style={{ width: `${progress}%` }}
            >
            </div>
          </div>
          <div className="flex justify-between text-xs text-blue-100 font-medium mb-4">
            <span>ç¸½é€²åº¦</span>
            <span>{progress}% å®Œæˆ</span>
          </div>

          {/* Tab Navigation */}
          <div 
            ref={scrollContainerRef}
            className="flex overflow-x-auto gap-2 pb-2 -mx-4 px-4 no-scrollbar items-center select-none"
            style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}
          >
            {categories.map(cat => {
              const isActive = activeCategory === cat;
              // Check if category is completed
              const catItems = items.filter(i => i.category === cat);
              const isCompleted = catItems.length > 0 && catItems.every(i => i.checked);
              
              return (
                <button
                  key={cat}
                  onClick={() => setActiveCategory(cat)}
                  className={`
                    whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold transition-all duration-200 flex items-center gap-1.5 flex-shrink-0
                    ${isActive 
                      ? 'bg-white text-blue-600 shadow-md scale-105' 
                      : 'bg-blue-800/30 text-blue-100 hover:bg-blue-800/50 hover:text-white border border-transparent'
                    }
                    ${!isActive && isCompleted ? 'border-green-400/50 text-green-100' : ''}
                  `}
                >
                  {isCompleted && !isActive && <Check className="w-3 h-3" />}
                  {cat}
                </button>
              );
            })}
            
            {/* Add Category Button in Tabs */}
            <button
              onClick={() => setIsAddingCategory(true)}
              className="whitespace-nowrap px-3 py-2 rounded-full text-sm font-bold transition-all duration-200 flex items-center gap-1 flex-shrink-0 bg-blue-800/30 text-blue-100 hover:bg-white hover:text-blue-600 border border-transparent border-dashed border-blue-300/50"
              title="æ–°å¢åˆ†é¡"
            >
              <Plus className="w-4 h-4" />
            </button>
          </div>
        </div>
      </div>

      {/* Main Content - Single Category View */}
      <div className="max-w-3xl mx-auto px-4 py-6 space-y-6">
        <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden min-h-[50vh]">
          {/* Category Header */}
          <div className={`px-4 py-4 border-b border-slate-100 flex justify-between items-center ${allChecked ? 'bg-green-50' : 'bg-slate-50'}`}>
            <h2 className="font-bold text-xl text-slate-700">{activeCategory}</h2>
            <span className={`text-xs font-bold px-3 py-1.5 rounded-full border ${allChecked ? 'bg-green-100 text-green-700 border-green-200' : 'bg-white text-slate-500 border-slate-200'}`}>
              {activeCategoryProgress.current} / {activeCategoryProgress.total}
            </span>
          </div>
          
          {/* Items List */}
          <div className="divide-y divide-slate-50">
            {currentCategoryItems.length > 0 ? (
              currentCategoryItems.map(item => (
                <div 
                  key={item.id} 
                  className={`flex items-start gap-3 p-4 transition-colors hover:bg-slate-50 animate-in fade-in duration-300 ${item.checked ? 'bg-slate-50/80' : ''}`}
                >
                  <button 
                    onClick={() => toggleCheck(item.id)}
                    className={`mt-1 flex-shrink-0 w-6 h-6 rounded-md border-2 flex items-center justify-center transition-all duration-200 ${
                      item.checked 
                        ? 'bg-blue-500 border-blue-500 text-white' 
                        : 'border-slate-300 text-transparent hover:border-blue-400'
                    }`}
                  >
                    <Check className="w-4 h-4 stroke-[3]" />
                  </button>

                  <div className="flex-grow min-w-0 cursor-pointer" onClick={() => toggleCheck(item.id)}>
                    <div className={`font-medium text-lg leading-snug ${item.checked ? 'text-slate-400 line-through decoration-slate-300' : 'text-slate-700'}`}>
                      {item.name}
                    </div>
                    {(item.note || item.checked) && (
                      <div className={`text-sm mt-1 flex items-start gap-1 ${item.checked ? 'text-slate-300' : 'text-amber-600'}`}>
                          {!item.checked && item.note && <AlertCircle className="w-3.5 h-3.5 mt-0.5 flex-shrink-0" />}
                          {item.note}
                      </div>
                    )}
                  </div>

                  <div className="flex items-center gap-1">
                    <button 
                      onClick={(e) => { e.stopPropagation(); setEditingItem(item); }}
                      className="p-2 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors"
                    >
                      <Edit3 className="w-4 h-4" />
                    </button>
                    <button 
                      onClick={(e) => { e.stopPropagation(); requestDelete(item.id); }}
                      className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              ))
            ) : (
              <div className="p-10 text-center text-slate-400 flex flex-col items-center">
                <ShoppingBag className="w-12 h-12 mb-2 opacity-20" />
                <p>é€™å€‹åˆ†é¡é‚„æ²’æœ‰ç‰©å“</p>
                <button 
                  onClick={() => { setNewItemCategory(activeCategory); setIsAdding(true); }}
                  className="mt-4 text-blue-500 font-medium hover:underline"
                >
                  æ–°å¢ç¬¬ä¸€é …ç‰©å“
                </button>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Floating Action Button */}
      <button 
        onClick={() => {
          setNewItemCategory(activeCategory);
          setIsAdding(true);
        }}
        className="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-xl transition-transform hover:scale-105 active:scale-95 flex items-center gap-2 font-bold z-30"
      >
        <Plus className="w-6 h-6" />
        <span className="hidden sm:inline">æ–°å¢ç‰©å“</span>
      </button>

      {/* Confirmation Modal */}
      {confirmModal.isOpen && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl scale-100">
            <div className="p-6 text-center">
              <div className="w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center mx-auto mb-4">
                <AlertTriangle className="w-6 h-6" />
              </div>
              <h3 className="font-bold text-lg text-slate-800 mb-2">{confirmModal.title}</h3>
              <p className="text-slate-500 text-sm">{confirmModal.message}</p>
            </div>
            <div className="flex border-t border-slate-100">
              <button 
                onClick={() => setConfirmModal({ ...confirmModal, isOpen: false })}
                className="flex-1 px-4 py-3 text-slate-600 font-medium hover:bg-slate-50 transition-colors border-r border-slate-100"
              >
                å–æ¶ˆ
              </button>
              <button 
                onClick={handleConfirm}
                className="flex-1 px-4 py-3 text-red-600 font-bold hover:bg-red-50 transition-colors"
              >
                ç¢ºèª
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Add Category Modal */}
      {isAddingCategory && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
          <form onSubmit={handleAddCategory} className="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl scale-100">
            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
              <h3 className="font-bold text-lg text-slate-800">æ–°å¢åˆ†é¡</h3>
              <button type="button" onClick={() => setIsAddingCategory(false)} className="text-slate-400 hover:text-slate-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <div className="p-6 space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">åˆ†é¡åç¨±</label>
                <div className="relative">
                  <Tag className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                  <input 
                    type="text" 
                    autoFocus
                    required
                    placeholder="ä¾‹å¦‚ï¼š3Cç”¨å“"
                    value={newCategoryNameStr}
                    onChange={(e) => setNewCategoryNameStr(e.target.value)}
                    className="w-full pl-10 pr-4 py-3 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all text-lg"
                  />
                </div>
              </div>
            </div>

            <div className="p-4 border-t border-slate-100 flex justify-end gap-3 bg-slate-50">
              <button 
                type="button" 
                onClick={() => setIsAddingCategory(false)}
                className="px-4 py-2 text-slate-600 font-medium hover:bg-slate-200 rounded-lg transition-colors"
              >
                å–æ¶ˆ
              </button>
              <button 
                type="submit"
                className="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm"
              >
                æ–°å¢åˆ†é¡
              </button>
            </div>
          </form>
        </div>
      )}

      {/* Add Item Modal */}
      {isAdding && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
          <form onSubmit={addItem} className="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl scale-100">
            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
              <h3 className="font-bold text-lg text-slate-800">æ–°å¢ç‰©å“</h3>
              <button type="button" onClick={() => setIsAdding(false)} className="text-slate-400 hover:text-slate-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <div className="p-6 space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">ç‰©å“åç¨±</label>
                <input 
                  type="text" 
                  autoFocus
                  required
                  placeholder="ä¾‹å¦‚ï¼šè½‰æ¥é ­"
                  value={newItemName}
                  onChange={(e) => setNewItemName(e.target.value)}
                  className="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all text-lg"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">åˆ†é¡</label>
                <select 
                  value={newItemCategory}
                  onChange={(e) => setNewItemCategory(e.target.value)}
                  className="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none bg-white"
                >
                  {categories.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">å‚™è¨» (é¸å¡«)</label>
                <input 
                  type="text" 
                  placeholder="ä¾‹å¦‚ï¼šæ”¾éš¨èº«è¡Œæ"
                  value={newItemNote}
                  onChange={(e) => setNewItemNote(e.target.value)}
                  className="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all"
                />
              </div>
            </div>

            <div className="p-4 border-t border-slate-100 flex justify-end gap-3 bg-slate-50">
              <button 
                type="button" 
                onClick={() => setIsAdding(false)}
                className="px-4 py-2 text-slate-600 font-medium hover:bg-slate-200 rounded-lg transition-colors"
              >
                å–æ¶ˆ
              </button>
              <button 
                type="submit"
                className="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm"
              >
                æ–°å¢
              </button>
            </div>
          </form>
        </div>
      )}

      {/* Edit Item Modal */}
      {editingItem && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
          <form onSubmit={updateItem} className="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl">
             <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
              <h3 className="font-bold text-lg text-slate-800">ç·¨è¼¯ç‰©å“</h3>
              <button type="button" onClick={() => setEditingItem(null)} className="text-slate-400 hover:text-slate-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            
            <div className="p-6 space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">ç‰©å“åç¨±</label>
                <input 
                  type="text" 
                  required
                  value={editingItem.name}
                  onChange={(e) => setEditingItem({...editingItem, name: e.target.value})}
                  className="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all text-lg"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">åˆ†é¡</label>
                <select 
                  value={editingItem.category}
                  onChange={(e) => setEditingItem({...editingItem, category: e.target.value})}
                  className="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none bg-white"
                >
                  {categories.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">å‚™è¨»</label>
                <input 
                  type="text" 
                  value={editingItem.note}
                  onChange={(e) => setEditingItem({...editingItem, note: e.target.value})}
                  className="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all"
                />
              </div>
            </div>

            <div className="p-4 border-t border-slate-100 flex justify-end gap-3 bg-slate-50">
              <button 
                type="button" 
                onClick={() => setEditingItem(null)}
                className="px-4 py-2 text-slate-600 font-medium hover:bg-slate-200 rounded-lg transition-colors"
              >
                å–æ¶ˆ
              </button>
              <button 
                type="submit"
                className="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm"
              >
                å„²å­˜è®Šæ›´
              </button>
            </div>
          </form>
        </div>
      )}
    </div>
  );
}